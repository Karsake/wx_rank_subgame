{"version":3,"sources":["../../../../assets/Script/assets/Script/GameRankingList.js"],"names":["cc","Class","extends","Component","properties","scrollViewContent","Node","prefabRankItem","Prefab","loadingLabel","start","removeChild","window","wx","undefined","onMessage","log","data","messageType","fetchFriendData","MAIN_MENU_NUM","submitScore","score","fetchGroupFriendData","shareTicket","getUserCloudStorage","keyList","success","getres","console","KVDataList","length","value","setUserCloudStorage","key","res","fail","complete","node","removeChildByTag","active","removeAllChildren","string","getUserInfo","openIdList","userRes","userData","getFriendCloudStorage","sort","a","b","temp","i","playerInfo","item","instantiate","getComponent","init","addChild","setPosition","avatarUrl","userItem","y","getGroupCloudStorage"],"mappings":"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","file":"GameRankingList.js","sourceRoot":"../../../../assets/Script","sourcesContent":["cc.Class({\n    extends: cc.Component,\n\n    properties: {\n        scrollViewContent: cc.Node,\n        prefabRankItem: cc.Prefab,\n        loadingLabel: cc.Node,//加载文字\n    },\n\n    start() {\n        this.removeChild();\n        if (window.wx != undefined) {\n            window.wx.onMessage(data => {\n                cc.log(\"接收主域发来消息：\", data)\n                if (data.messageType == 0) {//移除排行榜\n                    this.removeChild();\n                } else if (data.messageType == 1) {//获取好友排行榜\n                    this.fetchFriendData(data.MAIN_MENU_NUM);\n                } else if (data.messageType == 3) {//提交得分\n                    this.submitScore(data.MAIN_MENU_NUM, data.score);\n                } else if (data.messageType == 5) {//获取群排行榜\n                    this.fetchGroupFriendData(data.MAIN_MENU_NUM, data.shareTicket);\n                }\n            });\n        } else {\n            this.fetchFriendData(1000);\n        }\n    },\n    submitScore(MAIN_MENU_NUM, score) { //提交得分\n        if (window.wx != undefined) {\n            window.wx.getUserCloudStorage({\n                // 以key/value形式存储\n                keyList: [MAIN_MENU_NUM],\n                success: function (getres) {\n                    console.log('getUserCloudStorage', 'success', getres)\n                    if (getres.KVDataList.length != 0) {\n                        if (getres.KVDataList[0].value > score) {\n                            return;\n                        }\n                    }\n                    // 对用户托管数据进行写数据操作\n                    window.wx.setUserCloudStorage({\n                        KVDataList: [{key: MAIN_MENU_NUM, value: \"\" + score}],\n                        success: function (res) {\n                            console.log('setUserCloudStorage', 'success', res)\n                        },\n                        fail: function (res) {\n                            console.log('setUserCloudStorage', 'fail')\n                        },\n                        complete: function (res) {\n                            console.log('setUserCloudStorage', 'ok')\n                        }\n                    });\n                },\n                fail: function (res) {\n                    console.log('getUserCloudStorage', 'fail')\n                },\n                complete: function (res) {\n                    console.log('getUserCloudStorage', 'ok')\n                }\n            });\n        } else {\n            cc.log(\"提交得分:\" + MAIN_MENU_NUM + \" : \" + score)\n        }\n    },\n    removeChild() {\n        this.node.removeChildByTag(1000);\n        this.scrollViewContent.active = false;\n        this.scrollViewContent.removeAllChildren();\n        this.loadingLabel.string = \"玩命加载中...\";\n        this.loadingLabel.active = true;\n    },\n\n    fetchFriendData(MAIN_MENU_NUM) {\n        this.removeChild();\n        this.scrollViewContent.active = true;\n        if (window.wx != undefined) {\n            wx.getUserInfo({\n                openIdList: ['selfOpenId'],\n                success: (userRes) => {\n                    this.loadingLabel.active = false;\n                    console.log('success', userRes.data)\n                    let userData = userRes.data[0];\n                    //取出所有好友数据\n                    wx.getFriendCloudStorage({\n                        keyList: [MAIN_MENU_NUM],\n                        success: res => {\n                            console.log(\"wx.getFriendCloudStorage success\", res);\n                            let data = res.data;\n                            data.sort((a, b) => {\n                                if (a.KVDataList.length == 0 && b.KVDataList.length == 0) {\n                                    return 0;\n                                }\n                                if (a.KVDataList.length == 0) {\n                                    return 1;\n                                }\n                                if (b.KVDataList.length == 0) {\n                                    return -1;\n                                }\n                                return b.KVDataList[0].value - a.KVDataList[0].value;\n                            });\n                            var temp;\n                            if(data.length > 5){\n                                temp = 5;\n                            }else{\n                                temp = data.length;\n                            }// 翻页功能，暂时只有一页****************SHOULD BE FIXED IMMEDIATELY ********************\n                            for (let i = 0; i < temp; i++) {\n                                var playerInfo = data[i];\n                                var item = cc.instantiate(this.prefabRankItem);\n                                item.getComponent('RankItem').init(i, playerInfo);\n                                this.scrollViewContent.addChild(item);\n                                item.setPosition(0,-65 - 132 * i);\n                                if (data[i].avatarUrl == userData.avatarUrl) {\n                                    let userItem = cc.instantiate(this.prefabRankItem);\n                                    userItem.getComponent('RankItem').init(i, playerInfo);\n                                    userItem.y = -300;\n                                    this.node.addChild(userItem,1,1000);\n                                }\n                            }\n                        },\n                        fail: res => {\n                            console.log(\"wx.getFriendCloudStorage fail\", res);\n                            this.loadingLabel.string = \"数据加载失败，请检测网络，谢谢。\";\n                        },\n                    });\n                },\n                fail: (res) => {\n                    this.loadingLabel.string = \"数据加载失败，请检测网络，谢谢。\";\n                }\n            });\n        }\n    },\n    fetchGroupFriendData(MAIN_MENU_NUM, shareTicket) {\n        console.log(\"获取群排行\");\n        this.removeChild();\n        this.scrollViewContent.active = true;\n        if (window.wx != undefined) {\n            wx.getUserInfo({\n                openIdList: ['selfOpenId'],\n                success: (userRes) => {\n                    console.log('success', userRes.data)\n                    let userData = userRes.data[0];\n                    //取出所有好友数据\n                    wx.getGroupCloudStorage({\n                        shareTicket: shareTicket,\n                        keyList: [MAIN_MENU_NUM],\n                        success: res => {\n                            console.log(\"wx.getGroupCloudStorage success\", res);\n                            this.loadingLabel.active = false;\n                            let data = res.data;\n                            data.sort((a, b) => {\n                                if (a.KVDataList.length == 0 && b.KVDataList.length == 0) {\n                                    return 0;\n                                }\n                                if (a.KVDataList.length == 0) {\n                                    return 1;\n                                }\n                                if (b.KVDataList.length == 0) {\n                                    return -1;\n                                }\n                                return b.KVDataList[0].value - a.KVDataList[0].value;\n                            });\n                            for (let i = 0; i < data.length; i++) {\n                                var playerInfo = data[i];\n                                var item = cc.instantiate(this.prefabRankItem);\n                                item.getComponent('RankItem').init(i, playerInfo);\n                                this.scrollViewContent.addChild(item);\n                                if (data[i].avatarUrl == userData.avatarUrl) {\n                                    let userItem = cc.instantiate(this.prefabRankItem);\n                                    userItem.getComponent('RankItem').init(i, playerInfo);\n                                    userItem.y = -300;\n                                    this.node.addChild(userItem, 1, 1000);\n                                }\n                            }\n                        },\n                        fail: res => {\n                            console.log(\"wx.getFriendCloudStorage fail\", res);\n                            this.loadingLabel.string = \"数据加载失败，请检测网络，谢谢。\";\n                        },\n                    });\n                },\n                fail: (res) => {\n                    this.loadingLabel.string = \"数据加载失败，请检测网络，谢谢。\";\n                }\n            });\n        }\n    },\n});\n"]}